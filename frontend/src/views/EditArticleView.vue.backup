<!-- eslint-disable vue/no-v-html -->
<template>
  <div class="edit-article-view">
    <NavBar />
    <div class="edit-container">
      <div class="article-form">
        <!-- å†…å®¹ç±»å‹é€‰æ‹© - å æ®æ•´è¡Œ -->
        <div class="form-group content-type-selector full-width">
          <label>å†…å®¹ç±»å‹ï¿½?/label>
          <div class="type-buttons">
            <button
              type="button"
              :class="['type-btn', { active: contentType === 'article' }]"
              @click="contentType = 'article'"
            >
              ğŸ“ æ–‡ç« 
            </button>
            <button
              type="button"
              :class="['type-btn', { active: contentType === 'media' }]"
              @click="contentType = 'media'"
            >
              ğŸ¬ åª’ä½“å¡ç‰‡
            </button>
          </div>
        </div>

        <!-- æ–‡ç« ç±»å‹é€‰æ‹©ï¼ˆä»…æ–‡ç« æ¨¡å¼æ˜¾ç¤ºï¿½?-->
        <div v-if="contentType === 'article'" class="form-group">
          <label>æ–‡ç« ç±»å‹ï¿½?/label>
          <select v-model="articleData.type">
            <option value="blog">åšå®¢</option>
            <option value="research">ç§‘ç ”æ—¥è®°</option>
            <option value="project">é¡¹ç›®</option>
            <option value="moment">éšç¬”</option>
          </select>
        </div>

        <!-- åª’ä½“ç±»å‹é€‰æ‹©ï¼ˆä»…åª’ä½“æ¨¡å¼æ˜¾ç¤ºï¿½?-->
        <div v-if="contentType === 'media'" class="form-group">
          <label>åª’ä½“ç±»å‹ï¿½?/label>
          <select v-model="mediaData.type">
            <option value="books">ä¹¦å•</option>
            <option value="novels">å°è¯´</option>
            <option value="movies">ç”µå½±</option>
          </select>
        </div>

        <!-- æ ‡é¢˜/åç§° -->
        <div v-if="contentType === 'article'" class="form-group">
          <label>æ–‡ç« æ ‡é¢˜ï¿½?/label>
          <input
            v-model="articleData.title"
            type="text"
            placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡ï¿½?
          />
        </div>
        <div v-if="contentType === 'media'" class="form-group">
          <label>åª’ä½“åç§°ï¿½?/label>
          <input
            v-model="mediaData.name"
            type="text"
            placeholder="è¯·è¾“å…¥åª’ä½“åï¿½?
          />
        </div>

        <!-- åª’ä½“å¡ç‰‡ç‰¹æœ‰å­—æ®µ - è¯„åˆ† -->
        <div v-if="contentType === 'media'" class="form-group">
          <label>è¯„åˆ†ï¿½?-10ï¼‰ï¼š</label>
          <input v-model.number="mediaData.rating" type="number" min="1" max="10" placeholder="è¯·è¾“å…¥è¯„ï¿½? />
        </div>

        <!-- æ–‡ç« ç‰¹æœ‰å­—æ®µ - æ ‡ç­¾ -->
        <div v-if="contentType === 'article'" class="form-group">
          <label>æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
          <input v-model="tagsInput" type="text" placeholder="ä¾‹å¦‚ï¼šæŠ€ï¿½?å‰ç«¯,Vue" />
        </div>

        <!-- æ–‡ç« ç‰¹æœ‰å­—æ®µ - ç½®é¡¶é€‰é¡¹ -->
        <div v-if="contentType === 'article'" class="form-group">
          <label class="checkbox-label">
            <input v-model="articleData.isTop" type="checkbox" />
            <span class="checkbox-text">ç½®é¡¶æ–‡ç« </span>
          </label>
        </div>

        <!-- å°é¢å›¾ç‰‡ - å æ®æ•´è¡Œ -->
        <div v-if="contentType === 'article'" class="form-group full-width">
          <label>å°é¢å›¾ç‰‡ï¿½?/label>
          <div class="image-manager">
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div class="image-preview-section">
              <div class="image-preview-container">
                <div v-if="articleData.image" class="image-preview">
                  <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                  <div v-if="currentImageLoading" class="image-loading">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">å›¾ç‰‡åŠ è½½ï¿½?..</span>
                  </div>
                  <!-- é”™è¯¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                  <div v-else-if="currentImageError" class="image-error">
                    <font-awesome-icon icon="exclamation-triangle" class="error-icon" />
                    <span class="error-text">å›¾ç‰‡åŠ è½½å¤±è´¥</span>
                    <button type="button" class="retry-btn" @click="retryImageLoad">
                      <font-awesome-icon icon="redo" />
                      é‡è¯•
                    </button>
                  </div>
                  <!-- æ­£å¸¸å›¾ç‰‡æ˜¾ç¤º -->
                  <img
                    v-else
                    :src="articleData.image"
                    alt="å°é¢é¢„è§ˆ"
                    @error="handleImageError"
                    @load="handleImageLoad"
                  />
                  <div class="image-overlay">
                    <button type="button" class="clear-btn" @click="articleData.image = ''">
                      <font-awesome-icon icon="trash" />
                    </button>
                  </div>
                </div>
                <div v-else class="image-placeholder">
                  <font-awesome-icon icon="image" class="placeholder-icon" />
                  <span class="placeholder-text">æš‚æ— å°é¢å›¾ç‰‡</span>
                </div>
              </div>
            </div>

            <!-- å›¾ç‰‡é“¾æ¥è¾“å…¥åŒºåŸŸ -->
            <div class="image-input-section">
              <div class="input-group">
                <label class="input-label">
                  <font-awesome-icon icon="link" />
                  å°é¢é“¾æ¥
                </label>
                <input
                  v-model="articleData.image"
                  type="text"
                  placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾ï¿½?
                  class="image-url-input"
                  @input="handleImageUrlInput"
                />
              </div>
              <button type="button" class="random-image-btn" @click="getRandomImage">
                <font-awesome-icon icon="dice" />
                éšæœºå›¾ç‰‡
              </button>
            </div>
          </div>
        </div>
        <div v-if="contentType === 'media'" class="form-group full-width">
          <label>åª’ä½“å°é¢ï¿½?/label>
          <div class="image-manager">
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div class="image-preview-section">
              <div class="image-preview-container">
                <div v-if="mediaData.image" class="image-preview">
                  <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                  <div v-if="currentImageLoading" class="image-loading">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">å›¾ç‰‡åŠ è½½ï¿½?..</span>
                  </div>
                  <!-- é”™è¯¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                  <div v-else-if="currentImageError" class="image-error">
                    <font-awesome-icon icon="exclamation-triangle" class="error-icon" />
                    <span class="error-text">å›¾ç‰‡åŠ è½½å¤±è´¥</span>
                    <button type="button" class="retry-btn" @click="retryImageLoad">
                      <font-awesome-icon icon="redo" />
                      é‡è¯•
                    </button>
                  </div>
                  <!-- æ­£å¸¸å›¾ç‰‡æ˜¾ç¤º -->
                  <img
                    v-else
                    :src="mediaData.image"
                    alt="å°é¢é¢„è§ˆ"
                    @error="handleImageError"
                    @load="handleImageLoad"
                  />
                  <div class="image-overlay">
                    <button type="button" class="clear-btn" @click="mediaData.image = ''">
                      <font-awesome-icon icon="trash" />
                    </button>
                  </div>
                </div>
                <div v-else class="image-placeholder">
                  <font-awesome-icon icon="image" class="placeholder-icon" />
                  <span class="placeholder-text">æš‚æ— å°é¢å›¾ç‰‡</span>
                </div>
              </div>
            </div>

            <!-- å›¾ç‰‡é“¾æ¥è¾“å…¥åŒºåŸŸ -->
            <div class="image-input-section">
              <div class="input-group">
                <label class="input-label">
                  <font-awesome-icon icon="link" />
                  å°é¢é“¾æ¥
                </label>
                <input
                  v-model="mediaData.image"
                  type="text"
                  placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾ï¿½?
                  class="image-url-input"
                  @input="handleImageUrlInput"
                />
              </div>
              <button type="button" class="random-image-btn" @click="getRandomImage">
                <font-awesome-icon icon="dice" />
                éšæœºå›¾ç‰‡
              </button>
            </div>
          </div>
        </div>

        <!-- å›¾ç‰‡é€‰æ‹©ï¿½?-->
        <div v-if="showImagePicker" class="image-picker">
          <h4>é€‰æ‹©é¢„è®¾å›¾ç‰‡</h4>
          <div class="image-grid">
            <div
              v-for="img in presetImages"
              :key="img.id"
              class="image-option"
              :class="{ selected: (contentType === 'article' ? articleData.image : mediaData.image) === img.url }"
              @click="selectImage(img.url)"
            >
              <img :src="img.url" :alt="img.name" />
              <span class="image-name">{{ img.name }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ–‡ç« ç‰¹æœ‰å­—æ®µ - å æ®æ•´è¡Œ -->
      <div v-if="contentType === 'article' && articleData.type === 'research'" class="form-group full-width">
        <label>æ‘˜è¦ï¿½?/label>
        <textarea v-model="articleData.abstract" placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜ï¿½?></textarea>
      </div>
      <div v-if="contentType === 'article' && articleData.type === 'project'" class="form-group">
        <label>é¡¹ç›®çŠ¶æ€ï¼š</label>
        <select v-model="articleData.status">
          <option value="è¿›è¡Œï¿½?>è¿›è¡Œï¿½?/option>
          <option value="å·²å®Œï¿½?>å·²å®Œï¿½?/option>
          <option value="å·²æš‚ï¿½?>å·²æš‚ï¿½?/option>
        </select>
      </div>
    </div>

    <!-- Typoraé£æ ¼çš„æ‰€è§å³æ‰€å¾—ç¼–è¾‘å™¨ -->
    <div v-if="contentType === 'article'" class="typora-editor" :class="{ dark: isDark }">
      <div class="editor-toolbar">
        <div class="toolbar-group">
          <button title="ç²—ä½“ (Ctrl+B)" class="toolbar-btn" @click="execWysiwygCommand('bold')">
            <font-awesome-icon icon="bold" />
          </button>
          <button title="æ–œä½“ (Ctrl+I)" class="toolbar-btn" @click="execWysiwygCommand('italic')">
            <font-awesome-icon icon="italic" />
          </button>
          <button title="åˆ é™¤ï¿½? class="toolbar-btn" @click="execWysiwygCommand('strikeThrough')">
            <font-awesome-icon icon="strikethrough" />
          </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-group">
          <button title="æ ‡é¢˜ 1" class="toolbar-btn" @click="execHeadingCommand(1)">
            H1
          </button>
          <button title="æ ‡é¢˜ 2" class="toolbar-btn" @click="execHeadingCommand(2)">
            H2
          </button>
          <button title="æ ‡é¢˜ 3" class="toolbar-btn" @click="execHeadingCommand(3)">
            H3
          </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-group">
          <button title="é“¾æ¥ (Ctrl+K)" class="toolbar-btn" @click="execLinkCommand()">
            <font-awesome-icon icon="link" />
          </button>
          <button title="å›¾ç‰‡" class="toolbar-btn" @click="execImageCommand()">
            <font-awesome-icon icon="image" />
          </button>
          <button title="ä»£ç " class="toolbar-btn" @click="execCodeCommand()">
            <font-awesome-icon icon="code" />
          </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-group">
          <button title="å¼•ç”¨" class="toolbar-btn" @click="insertMarkdown('> ', '')">
            <font-awesome-icon icon="quote-left" />
          </button>
          <button title="æ— åºåˆ—è¡¨" class="toolbar-btn" @click="insertMarkdown('- ', '')">
            <font-awesome-icon icon="list-ul" />
          </button>
          <button title="æœ‰åºåˆ—è¡¨" class="toolbar-btn" @click="insertMarkdown('1. ', '')">
            <font-awesome-icon icon="list-ol" />
          </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-group">
          <button title="åˆ†å‰²ï¿½? class="toolbar-btn" @click="insertMarkdown('---\n', '')">
            <font-awesome-icon icon="minus" />
          </button>
          <button title="è¡¨æ ¼" class="toolbar-btn" @click="insertTable">
            <font-awesome-icon icon="table" />
          </button>
        </div>
        <div class="toolbar-spacer"></div>
        <div class="toolbar-group">
          <button title="åˆ‡æ¢ç¼–è¾‘æ¨¡å¼" class="toolbar-btn" @click="toggleEditorMode">
            <font-awesome-icon :icon="editorMode === 'wysiwyg' ? 'code' : 'eye'" />
            {{ editorMode === 'wysiwyg' ? 'æºç ' : 'é¢„è§ˆ' }}
          </button>
        </div>
      </div>

      <div class="editor-content">
        <!-- æ‰€è§å³æ‰€å¾—æ¨¡ï¿½?-->
        <div v-if="editorMode === 'wysiwyg'" class="wysiwyg-editor">
          <div
            ref="wysiwygContent"
            class="wysiwyg-content"
            contenteditable="true"
            :data-placeholder="markdownContent ? '' : '# å¼€å§‹å†™ä½œå§...\n\næ”¯æŒ Markdown è¯­æ³•ï¼š\n- **ç²—ä½“** *æ–œä½“*\n- # æ ‡é¢˜\n- [é“¾æ¥](url)\n- `ä»£ç `\n- > å¼•ç”¨\n\nğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´ï¿½?Ctrl+V ç²˜è´´å›¾ç‰‡ï¿½?"
            @input="handleWysiwygInput"
            @paste="handleWysiwygPaste"
            @keydown="handleWysiwygKeydown"
            @blur="syncWysiwygToMarkdown"
            v-html="renderedContent"
          ></div>
        </div>

        <!-- æºç æ¨¡å¼ -->
        <div v-else class="source-editor">
          <textarea
            ref="editorTextarea"
            v-model="markdownContent"
            placeholder="# å¼€å§‹å†™ä½œå§...&#10;&#10;æ”¯æŒ Markdown è¯­æ³•ï¿½?#10;- **ç²—ä½“** *æ–œä½“*&#10;- # æ ‡é¢˜&#10;- [é“¾æ¥](url)&#10;- `ä»£ç `&#10;- > å¼•ç”¨&#10;&#10;ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´ï¿½?Ctrl+V ç²˜è´´å›¾ç‰‡ï¿½?
            @input="updatePreview"
            @keydown.tab.prevent="handleTab"
            @paste="handlePaste"
            @keyup="updateCursorPosition"
            @click="updateCursorPosition"
          ></textarea>
        </div>
      </div>

      <div class="editor-footer">
        <div class="editor-stats">
          <span class="word-count">{{ wordCount }} ï¿½?/span>
          <span class="line-count">{{ lineCount }} ï¿½?/span>
          <span class="cursor-position">ï¿½?{{ cursorLine }} ï¿½?{{ cursorColumn }}</span>
        </div>
        <div class="editor-theme">
          <button class="theme-btn" @click="toggleTheme">
            <font-awesome-icon :icon="isDark ? 'sun' : 'moon'" />
            {{ isDark ? 'æµ…è‰²' : 'æ·±è‰²' }}
          </button>
        </div>
      </div>

      <!-- éšè—çš„æ–‡ä»¶è¾“ï¿½?-->
      <input
        ref="imageInput"
        type="file"
        accept="image/*"
        style="display: none"
        @change="handleImageUpload"
      />
    </div>

    <!-- åª’ä½“å¡ç‰‡ç¼–è¾‘ï¿½?-->
    <div v-if="contentType === 'media'" class="media-editor-container">
      <div class="media-editor">
        <div class="editor-header">
          <h3>ğŸ“ åª’ä½“è¯„ä»·ï¼ˆæ”¯ï¿½?Markdownï¿½?/h3>
          <div class="editor-toolbar">
            <button title="ç²—ä½“" class="toolbar-btn" @click="insertMediaMarkdown('**', '**')">
              <font-awesome-icon icon="bold" />
            </button>
            <button title="æ–œä½“" class="toolbar-btn" @click="insertMediaMarkdown('*', '*')">
              <font-awesome-icon icon="italic" />
            </button>
            <button title="æ ‡é¢˜" class="toolbar-btn" @click="insertMediaMarkdown('### ', '')">
              <font-awesome-icon icon="heading" />
            </button>
            <button title="é“¾æ¥" class="toolbar-btn" @click="insertMediaMarkdown('[', '](url)')">
              <font-awesome-icon icon="link" />
            </button>
            <button title="ä»£ç " class="toolbar-btn" @click="insertMediaMarkdown('`', '`')">
              <font-awesome-icon icon="code" />
            </button>
            <button title="å¼•ç”¨" class="toolbar-btn" @click="insertMediaMarkdown('> ', '')">
              <font-awesome-icon icon="quote-left" />
            </button>
            <button title="åˆ—è¡¨" class="toolbar-btn" @click="insertMediaMarkdown('- ', '')">
              <font-awesome-icon icon="list" />
            </button>
          </div>
        </div>
        <textarea
          ref="mediaTextarea"
          v-model="mediaData.description"
          placeholder="# å†™ä¸‹ä½ çš„è¯„ä»·ï¿½?..&#10;&#10;æ”¯æŒ Markdown è¯­æ³•ï¿½?#10;- **ç²—ä½“** *æ–œä½“*&#10;- ### æ ‡é¢˜&#10;- [é“¾æ¥](url)&#10;- `ä»£ç `&#10;- > å¼•ç”¨&#10;- - åˆ—è¡¨&#10;&#10;ğŸ’¡ åˆ†äº«ä½ çš„è§‚å½±/é˜…è¯»æ„Ÿå—ï¿½?
          class="media-textarea"
          @keydown.tab.prevent="handleMediaTab"
        ></textarea>
        <div class="editor-footer">
          <span class="word-count">{{ mediaData.description ? mediaData.description.length : 0 }} ï¿½?/span>
          <button class="preview-toggle-btn" @click="showMediaPreview = !showMediaPreview">
            <font-awesome-icon :icon="showMediaPreview ? 'eye-slash' : 'eye'" />
            {{ showMediaPreview ? 'éšè—' : 'æ˜¾ç¤º' }}é¢„è§ˆ
          </button>
        </div>
      </div>

      <!-- åª’ä½“é¢„è§ˆé¢æ¿ -->
      <div v-if="showMediaPreview" class="media-preview-panel">
        <div class="preview-header">
          <h3>ï¿½?é¢„è§ˆæ•ˆæœ</h3>
        </div>
        <div v-if="mediaData.description" class="media-preview markdown-body" v-html="sanitizedMediaContent"></div>
        <div v-else class="empty-preview">
          <font-awesome-icon icon="box-open" class="empty-icon" />
          <p>å¼€å§‹è¾“å…¥ä»¥æŸ¥çœ‹é¢„è§ˆæ•ˆæœ</p>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="save-btn" :disabled="!canSave" @click="contentType === 'article' ? saveArticle() : saveMedia()">
        {{ isEditing ? (contentType === 'article' ? 'æ›´æ–°æ–‡ç« ' : 'æ›´æ–°å¡ç‰‡') : (contentType === 'article' ? 'å‘å¸ƒæ–‡ç« ' : 'åˆ›å»ºå¡ç‰‡') }}
      </button>
      <button v-if="hasChanges" class="discard-btn" @click="discardChanges">æ”¾å¼ƒæ›´æ”¹</button>
    </div>
  </div>
</template>

<script setup>
import { ref, nextTick, computed, onMounted, onBeforeUnmount } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useStore } from 'vuex'
import axios from 'axios'
import DOMPurify from 'dompurify' // é˜²æ­¢XSSæ”»å‡»
import { marked } from 'marked'
import hljs from 'highlight.js'
import '@/assets/styles/github-highlight.css'
import '@/assets/styles/github-markdown.css'
import NavBar from '@/components/NavBar.vue'
import { createArticle, updateArticle } from '@/api/Articles/edit'
import { getJWT, requestFunc } from '@/api/req'
import { getArticleByID } from '@/api/Articles/browse'
import { imageConfig } from '@/config/images'
import apiConfig from '@/config/api'
import { showErrorMessage, showSuccessMessage, showWarningMessage, showCustomMessage } from '@/utils/waifuMessage'

const route = useRoute()
const router = useRouter()
const store = useStore()

const contentType = ref('article') // 'article' ï¿½?'media'
const markdownContent = ref('')
const renderedContent = ref('')
const sanitizedContent = ref('')
const tagsInput = ref('')
const showImagePicker = ref(false)
const editorMode = ref('wysiwyg') // 'wysiwyg' ï¿½?'source'
const isDark = ref(false) // ä¸»é¢˜æ¨¡å¼
const cursorLine = ref(1) // å…‰æ ‡è¡Œå·
const cursorColumn = ref(1) // å…‰æ ‡åˆ—å·
const editorTextarea = ref(null)
const imageInput = ref(null)
const wysiwygContent = ref(null)
const showMediaPreview = ref(false)
const mediaTextarea = ref(null)

// å›¾ç‰‡åŠ è½½çŠ¶æ€ç®¡ï¿½?const imageLoadingStates = ref(new Map())
const imageCache = ref(new Map())
const imageRetryCount = ref(new Map())

const articleData = ref({
  title: '',
  type: 'blog',
  image: '',
  abstract: '',
  status: 'è¿›è¡Œï¿½?,
  tags: [],
  isTop: false
})

const mediaData = ref({
  name: '',
  type: 'books',
  image: '',
  rating: 8,
  description: ''
})

// ä»é…ç½®æ–‡ä»¶åŠ è½½é¢„è®¾å›¾ï¿½?const presetImages = ref(imageConfig.presetArticleImages)

const isEditing = computed(() => !!route.params.id)

// åŸå§‹æ•°æ®ï¼Œç”¨äºæ£€æµ‹æ˜¯å¦æœ‰æ›´æ”¹
const originalArticleData = ref(null)
const originalMediaData = ref(null)
const originalMarkdownContent = ref('')
const originalTagsInput = ref('')

const canSave = computed(() => {
  if (contentType.value === 'article') {
    return articleData.value.title.trim() && markdownContent.value.trim()
  } else {
    return mediaData.value.name.trim() && mediaData.value.rating >= 1 && mediaData.value.rating <= 10
  }
})

// æ£€æµ‹æ˜¯å¦æœ‰æ›´æ”¹
const hasChanges = computed(() => {
  if (contentType.value === 'article') {
    if (!originalArticleData.value) return false

    return (
      articleData.value.title !== originalArticleData.value.title ||
      articleData.value.image !== originalArticleData.value.image ||
      articleData.value.type !== originalArticleData.value.type ||
      articleData.value.isTop !== originalArticleData.value.isTop ||
      markdownContent.value !== originalMarkdownContent.value ||
      tagsInput.value !== originalTagsInput.value
    )
  } else {
    if (!originalMediaData.value) return false

    return (
      mediaData.value.name !== originalMediaData.value.name ||
      mediaData.value.image !== originalMediaData.value.image ||
      mediaData.value.type !== originalMediaData.value.type ||
      mediaData.value.rating !== originalMediaData.value.rating ||
      mediaData.value.description !== originalMediaData.value.description
    )
  }
})

// å­—æ•°ç»Ÿè®¡
const wordCount = computed(() => {
  return markdownContent.value.replace(/\s/g, '').length
})

// è¡Œæ•°ç»Ÿè®¡
const lineCount = computed(() => {
  return markdownContent.value.split('\n').length
})

// åª’ä½“å†…å®¹é¢„è§ˆï¼ˆMarkdown æ¸²æŸ“ï¿½?const sanitizedMediaContent = computed(() => {
  if (!mediaData.value.description) return ''
  const rendered = marked(mediaData.value.description)
  return DOMPurify.sanitize(rendered)
})

// å›¾ç‰‡åŠ è½½çŠ¶æ€è®¡ç®—å±ï¿½?const currentImageLoading = computed(() => {
  const currentImage = contentType.value === 'article' ? articleData.value.image : mediaData.value.image
  if (!currentImage) return false

  const loading = imageLoadingStates.value.get(currentImage) || false
  console.log('å½“å‰å›¾ç‰‡åŠ è½½çŠ¶ï¿½?', { currentImage, loading })
  return loading
})

const currentImageError = computed(() => {
  const currentImage = contentType.value === 'article' ? articleData.value.image : mediaData.value.image
  if (!currentImage) return false

  // åªæœ‰åœ¨é‡è¯•æ¬¡æ•°è¶…ï¿½?æ¬¡ä¸”å›¾ç‰‡ç¡®å®åŠ è½½å¤±è´¥æ—¶æ‰æ˜¾ç¤ºé”™è¯¯
  const retryCount = imageRetryCount.value.get(currentImage) || 0
  const isLoading = imageLoadingStates.value.get(currentImage) || false
  const hasError = retryCount > 3 && !isLoading

  console.log('å½“å‰å›¾ç‰‡é”™è¯¯çŠ¶ï¿½?', { currentImage, retryCount, isLoading, hasError })
  return hasError
})

// æ›´æ–°é¢„è§ˆå¹¶è¿›è¡Œé«˜ï¿½?const updatePreview = () => {
  // ä½¿ç”¨ marked æ¸²æŸ“ Markdownï¼Œç¡®ä¿ä»£ç å—ç»“æ„æ­£ç¡®
  renderedContent.value = marked(markdownContent.value, {
    breaks: false, // ä¸å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
    gfm: true, // å¯ç”¨ GitHub Flavored Markdown
    headerIds: false,
    mangle: false
  })

  // åœ¨æ¸²æŸ“åï¿½?HTML ä¸­æ·»åŠ å†…è”æ ·å¼å¼ºåˆ¶å·¦å¯¹é½
  const tempDiv = document.createElement('div')
  tempDiv.innerHTML = renderedContent.value

  // ä¸ºæ‰€æœ‰å—çº§å…ƒç´ æ·»ï¿½?text-align: left
  const blockElements = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div, ul, ol, li, blockquote, pre')
  blockElements.forEach(el => {
    el.style.textAlign = 'left'
    el.style.textAlignLast = 'left'
  })

  // ç¡®ä¿ä»£ç å—æœ‰æ­£ç¡®çš„ç»“ï¿½?  const codeBlocks = tempDiv.querySelectorAll('pre code')
  console.log('æ‰¾åˆ°çš„ä»£ç å—æ•°é‡:', codeBlocks.length) // è°ƒè¯•ï¿½?  console.log('Marked æ¸²æŸ“çš„å®Œæ•´HTML:', renderedContent.value) // è°ƒè¯•ï¿½?
  codeBlocks.forEach(block => {
    console.log('ä»£ç å—å†…ï¿½?', block.textContent) // è°ƒè¯•ï¿½?    console.log('ä»£ç å—HTML:', block.outerHTML) // è°ƒè¯•ï¿½?    // ç¡®ä¿ä»£ç å—æ˜¯å—çº§å…ƒç´ 
    block.style.display = 'block'
    block.style.whiteSpace = 'pre'
    block.style.overflow = 'visible'
    block.style.wordBreak = 'normal'
  })

  renderedContent.value = tempDiv.innerHTML

  // ä½¿ç”¨æ›´å®½æ¾çš„ DOMPurify é…ç½®ï¼Œç¡®ä¿ä»£ç å—ä¸è¢«è¿‡æ»¤
  sanitizedContent.value = DOMPurify.sanitize(renderedContent.value, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'pre', 'code', 'span', 'div'],
    ALLOWED_ATTR: ['class', 'style']
  })

  // ç¡®ä¿ï¿½?DOM æ›´æ–°åé«˜äº®ä»£ç å—ï¼ˆä¸æ·»åŠ å¤åˆ¶æŒ‰é’®ï¿½?  nextTick(() => {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ä»£ç å—å®Œå…¨æ¸²æŸ“
    setTimeout(() => {
      const finalCodeBlocks = document.querySelectorAll('pre code')
      console.log('DOM ä¸­çš„ä»£ç å—æ•°ï¿½?', finalCodeBlocks.length) // è°ƒè¯•ï¿½?
      finalCodeBlocks.forEach((block) => {
        console.log('DOM ä»£ç å—å†…ï¿½?', block.textContent) // è°ƒè¯•ï¿½?        // ç¡®ä¿ä»£ç å—æ²¡æœ‰è¢«ç ´å
        if (block.textContent && block.textContent.trim()) {
          hljs.highlightElement(block)
        }
      })
    }, 100) // å»¶è¿Ÿ100msç¡®ä¿æ¸²æŸ“å®Œæˆ
  })
}

// åª’ä½“ç¼–è¾‘å™¨æ’ï¿½?Markdown
const insertMediaMarkdown = (before, after) => {
  const textarea = mediaTextarea.value
  if (!textarea) return

  const start = textarea.selectionStart
  const end = textarea.selectionEnd
  const selectedText = mediaData.value.description.substring(start, end)
  const beforeText = mediaData.value.description.substring(0, start)
  const afterText = mediaData.value.description.substring(end)

  mediaData.value.description = beforeText + before + selectedText + after + afterText

  nextTick(() => {
    textarea.focus()
    textarea.setSelectionRange(
      start + before.length,
      start + before.length + selectedText.length
    )
  })
}

// åª’ä½“ç¼–è¾‘ï¿½?Tab é”®å¤„ï¿½?const handleMediaTab = (event) => {
  const textarea = mediaTextarea.value
  if (!textarea) return

  const start = textarea.selectionStart
  const end = textarea.selectionEnd

  // æ’å…¥ä¸¤ä¸ªç©ºæ ¼
  mediaData.value.description =
    mediaData.value.description.substring(0, start) +
    '  ' +
    mediaData.value.description.substring(end)

  // ç§»åŠ¨å…‰æ ‡
  nextTick(() => {
    textarea.selectionStart = textarea.selectionEnd = start + 2
  })
}

// ä¿å­˜æ–‡ç« 
const saveArticle = async () => {
  if (!canSave.value) return

  try {
    const user = store.state.user
    const token = getJWT()
    if (!user || !user.isLogged || !token) {
      showErrorMessage('401')
      return
    }

    // å¤„ç†æ ‡ç­¾ - ç¡®ä¿å‘é€æ­£ç¡®çš„JSONæ ¼å¼
    const tagsArray = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag)
    articleData.value.tags = tagsArray

    // ç¢ç¢å¿µä½¿ç”¨ä¸åŒçš„ API
    if (articleData.value.type === 'moment') {
      const { createMoment, updateMoment } = await import('@/api/Moments/edit')
      if (isEditing.value) {
        await updateMoment(user, route.params.id, articleData.value.title, markdownContent.value, articleData.value.image)
        showSuccessMessage('update')
      } else {
        await createMoment(user, articleData.value.title, markdownContent.value, articleData.value.image, user.username)
        showSuccessMessage('submit')
      }
      router.push('/moments')
      return
    }

    // æ ¹æ®æ–‡ç« ç±»å‹è®¾ç½®å†…å®¹
    const articlePayload = {
      title: articleData.value.title,
      image: articleData.value.image,
      tags: articleData.value.tags
    }

    if (articleData.value.type === 'blog') {
      articlePayload.content = markdownContent.value
    } else if (articleData.value.type === 'research') {
      articlePayload.abstract = articleData.value.abstract
    } else if (articleData.value.type === 'project') {
      articlePayload.status = articleData.value.status
    }

    if (isEditing.value) {
      console.log('æ­£åœ¨æ›´æ–°æ–‡ç« ...', { token, articlePayload, type: articleData.value.type, id: route.params.id })
      await updateArticle(token, articlePayload, articleData.value.type, route.params.id)
      showSuccessMessage('update')
    } else {
      console.log('æ­£åœ¨åˆ›å»ºæ–‡ç« ...', { token, articlePayload, type: articleData.value.type })
      await createArticle(token, articlePayload, articleData.value.type)
      showSuccessMessage('submit')
    }

    // è·³è½¬åˆ°å¯¹åº”é¡µï¿½?    router.push(`/${articleData.value.type}`)
  } catch (error) {
    showErrorMessage(error)
  }
}

// ä¿å­˜åª’ä½“å¡ç‰‡
const saveMedia = async () => {
  if (!canSave.value) return

  try {
    const user = store.state.user
    const token = getJWT()
    if (!user || !user.isLogged || !token) {
      showErrorMessage('401')
      return
    }

    const { createMedia, updateMedia } = await import('@/api/media/edit')

    // åç«¯å­—æ®µåï¼šPoster, Name, Review, Rating, Type
    const mediaPayload = {
      Poster: mediaData.value.image, // å‰ç«¯ image ï¿½?åç«¯ Poster
      Name: mediaData.value.name,
      Review: mediaData.value.description, // å‰ç«¯ description ï¿½?åç«¯ Review
      Rating: mediaData.value.rating,
      Type: mediaData.value.type,
      Date: new Date().toISOString().split('T')[0] // æ·»åŠ æ—¥æœŸ
    }

    console.log('ä¿å­˜çš„åª’ä½“æ•°ï¿½?', mediaPayload)

    if (isEditing.value) {
      await updateMedia(mediaData.value.type, route.params.id, mediaPayload)
      showSuccessMessage('update')
    } else {
      await createMedia(user, mediaPayload, mediaData.value.type) // (user, media, type)
      showSuccessMessage('submit')
    }

    // è·³è½¬åˆ°å¯¹åº”åª’ä½“é¡µï¿½?    router.push(`/${mediaData.value.type}`)
  } catch (error) {
    showErrorMessage(error)
  }
}

// é€‰æ‹©å›¾ç‰‡
const selectImage = (url) => {
  if (contentType.value === 'article') {
    articleData.value.image = url
  } else {
    mediaData.value.image = url
  }
  showImagePicker.value = false
}

// ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨ï¼ˆé€šç”¨å‡½æ•°ï¿½?const uploadImageFile = async (file) => {
  // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBï¿½?  if (file.size > 5 * 1024 * 1024) {
    showWarningMessage('file_too_large')
    return null
  }

  // æ£€æŸ¥æ–‡ä»¶ç±»ï¿½?  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
  if (!allowedTypes.includes(file.type)) {
    showWarningMessage('invalid_file_type')
    return null
  }

  // åˆ›å»º FormData
  const formData = new FormData()
  formData.append('image', file)

  try {
    // ä¸Šä¼ å›¾ç‰‡
    const token = getJWT()
    const response = await axios.post(`${apiConfig.apiURL}/upload/image`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
        Authorization: `Bearer ${token}`
      }
    })

    // è¿”å›å›¾ç‰‡ URL
    return apiConfig.baseURL + response.data.url
  } catch (error) {
    showErrorMessage('upload_failed')
    throw error
  }
}

// å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆæ–‡ä»¶é€‰æ‹©ï¿½?const handleImageUpload = async (event) => {
  const file = event.target.files[0]
  if (!file) return

  const textarea = editorTextarea.value
  const start = textarea.selectionStart

  try {
    // æ˜¾ç¤ºä¸Šä¼ ä¸­æï¿½?    const uploadingText = '\n\n![ä¸Šä¼ ï¿½?..]()\n\n'
    const beforeText = markdownContent.value.substring(0, start)
    const afterText = markdownContent.value.substring(start)
    markdownContent.value = beforeText + uploadingText + afterText

    // ä¸Šä¼ å›¾ç‰‡
    const imageUrl = await uploadImageFile(file)
    if (!imageUrl) {
      // ä¸Šä¼ å¤±è´¥ï¼Œç§»é™¤ä¸Šä¼ ä¸­æ–‡æœ¬
      markdownContent.value = markdownContent.value.replace(uploadingText, '')
      return
    }

    // æ›¿æ¢ä¸Šä¼ ä¸­æ–‡æœ¬ä¸ºå®é™…å›¾ç‰‡
    markdownContent.value = markdownContent.value.replace(
      uploadingText,
      `\n\n![${file.name}](${imageUrl})\n\n`
    )

    // æ›´æ–°é¢„è§ˆ
    updatePreview()

    showSuccessMessage('upload')
  } catch (error) {
    // ç§»é™¤ä¸Šä¼ ä¸­æ–‡ï¿½?    markdownContent.value = markdownContent.value.replace('\n\n![ä¸Šä¼ ï¿½?..]()\n\n', '')
    showErrorMessage('upload_failed')
  }

  // æ¸…ç©º input
  event.target.value = ''
}

// å¤„ç†ç²˜è´´äº‹ä»¶ï¼ˆCtrl+V ç²˜è´´å›¾ç‰‡ï¿½?const handlePaste = async (event) => {
  const items = event.clipboardData?.items
  if (!items) return

  // æŸ¥æ‰¾å›¾ç‰‡ï¿½?  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    if (item.type.indexOf('image') !== -1) {
      // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
      event.preventDefault()

      // è·å–å›¾ç‰‡æ–‡ä»¶
      const file = item.getAsFile()
      if (!file) continue

      const textarea = editorTextarea.value
      const start = textarea.selectionStart

      try {
        // æ˜¾ç¤ºä¸Šä¼ ä¸­æï¿½?        const uploadingText = '\n\n![ç²˜è´´å›¾ç‰‡ä¸Šä¼ ï¿½?..]()\n\n'
        const beforeText = markdownContent.value.substring(0, start)
        const afterText = markdownContent.value.substring(start)
        markdownContent.value = beforeText + uploadingText + afterText

        // ä¸Šä¼ å›¾ç‰‡
        const imageUrl = await uploadImageFile(file)
        if (!imageUrl) {
          // ä¸Šä¼ å¤±è´¥ï¼Œç§»é™¤ä¸Šä¼ ä¸­æ–‡æœ¬
          markdownContent.value = markdownContent.value.replace(uploadingText, '')
          return
        }

        // ç”Ÿæˆæ–‡ä»¶ï¿½?        const timestamp = new Date().getTime()
        const filename = `paste_${timestamp}.png`

        // æ›¿æ¢ä¸Šä¼ ä¸­æ–‡æœ¬ä¸ºå®é™…å›¾ç‰‡
        markdownContent.value = markdownContent.value.replace(
          uploadingText,
          `\n\n![${filename}](${imageUrl})\n\n`
        )

        // æ›´æ–°é¢„è§ˆ
        updatePreview()

        // ä¸æ˜¾ï¿½?alertï¼Œé¿å…æ‰“æ–­å†™ï¿½?        console.log('å›¾ç‰‡ç²˜è´´ä¸Šä¼ æˆåŠŸï¿½?)
      } catch (error) {
        // ç§»é™¤ä¸Šä¼ ä¸­æ–‡ï¿½?        markdownContent.value = markdownContent.value.replace('\n\n![ç²˜è´´å›¾ç‰‡ä¸Šä¼ ï¿½?..]()\n\n', '')
        showErrorMessage('upload_failed')
      }

      break
    }
  }
}

// æ’å…¥ Markdown è¯­æ³•
const insertMarkdown = (before, after) => {
  const textarea = editorTextarea.value
  if (!textarea) return

  const start = textarea.selectionStart
  const end = textarea.selectionEnd
  const selectedText = markdownContent.value.substring(start, end)
  const beforeText = markdownContent.value.substring(0, start)
  const afterText = markdownContent.value.substring(end)

  markdownContent.value = beforeText + before + selectedText + after + afterText

  // æ›´æ–°å…‰æ ‡ä½ç½®
  nextTick(() => {
    const newPos = start + before.length + selectedText.length
    textarea.focus()
    textarea.setSelectionRange(newPos, newPos)
  })

  updatePreview()
}

// å¤„ç† Tab ï¿½?const handleTab = (e) => {
  const textarea = editorTextarea.value
  if (!textarea) return

  const start = textarea.selectionStart
  const end = textarea.selectionEnd

  // æ’å…¥ä¸¤ä¸ªç©ºæ ¼
  markdownContent.value = markdownContent.value.substring(0, start) + '  ' + markdownContent.value.substring(end)

  // æ›´æ–°å…‰æ ‡ä½ç½®
  nextTick(() => {
    textarea.selectionStart = textarea.selectionEnd = start + 2
  })
}

// è·å–éšæœºå›¾ç‰‡
const getRandomImage = async () => {
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶ï¿½?    console.log('æ­£åœ¨è·å–å›¾ç‰‡...')

    // é€šè¿‡åç«¯APIè·å–éšæœºå›¾ç‰‡ - è®©åç«¯è‡ªå·±å†³å®šä½¿ç”¨å“ªä¸ªAPI
    console.log('æ­£åœ¨è·å–éšæœºå›¾ç‰‡...')

    const token = getJWT()
    console.log('è·å–åˆ°çš„token:', token ? 'å­˜åœ¨' : 'ä¸å­˜ï¿½?)
    console.log('localStorageä¸­çš„jwt:', localStorage.getItem('jwt'))
    console.log('å½“å‰é¡µé¢è·¯å¾„:', window.location.pathname)
    if (!token) {
      showErrorMessage('è¯·å…ˆç™»å½•åå†è·å–éšæœºå›¾ç‰‡')
      return
    }

    const response = await requestFunc('/random-image', {
      method: 'POST',
      data: {} // ä¸ä¼ é€’å…·ä½“APIï¼Œè®©åç«¯è‡ªå·±å†³å®š
    }, true)

    if (!response) {
      throw new Error('è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ')
    }

    const data = response.data
    console.log('åç«¯è¿”å›çš„æ•°ï¿½?', data)

    if (!data.success || !data.imageUrl) {
      throw new Error(data.message || 'åç«¯æœªèƒ½è·å–åˆ°å›¾ç‰‡URL')
    }

    const imageUrl = data.imageUrl
    console.log('åç«¯è¿”å›çš„å›¾ç‰‡URL:', imageUrl)

    // éªŒè¯å›¾ç‰‡URLæ˜¯å¦æœ‰æ•ˆ
    if (!imageUrl) {
      throw new Error('è·å–åˆ°çš„å›¾ç‰‡URLä¸ºç©º')
    }

      // è®¾ç½®å›¾ç‰‡URL
      if (contentType.value === 'article') {
        articleData.value.image = imageUrl
      } else {
        mediaData.value.image = imageUrl
      }

    // å¼‚æ­¥é¢„åŠ è½½å›¾ï¿½?    setTimeout(async () => {
      try {
        await preloadImage(imageUrl)
        console.log('å›¾ç‰‡é¢„åŠ è½½æˆï¿½?', imageUrl)
    } catch (error) {
        console.log('å›¾ç‰‡é¢„åŠ è½½å¤±è´¥ï¼Œä½†ä¸å½±å“æ˜¾ç¤º:', error)
      }
    }, 100)
  } catch (error) {
    console.error('è·å–éšæœºå›¾ç‰‡å¤±è´¥:', error)
    await useFallbackImage()
  }
}

// å¤‡ç”¨å›¾ç‰‡æ–¹æ¡ˆ
const useFallbackImage = async () => {
  try {
    // ä½¿ç”¨åç«¯APIè·å–å¤‡ç”¨å›¾ç‰‡
    const token = getJWT()
    if (!token) {
      showErrorMessage('è¯·å…ˆç™»å½•åå†è·å–éšæœºå›¾ç‰‡')
      return
    }

    const response = await requestFunc('/random-image', {
      method: 'POST',
      data: {
        apiUrl: 'https://api.r10086.com/img-api.php?type=åŠ¨æ¼«ç»¼åˆ1',
        apiName: 'æ¨±é“å¤‡ç”¨'
      }
    }, true)

    if (!response) {
      throw new Error('è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ')
    }

    const data = response.data
    if (!data.success || !data.imageUrl) {
      throw new Error(data.message || 'åç«¯æœªèƒ½è·å–åˆ°å¤‡ç”¨å›¾ç‰‡URL')
    }

    if (contentType.value === 'article') {
      articleData.value.image = data.imageUrl
    } else {
      mediaData.value.image = data.imageUrl
    }
    showWarningMessage('ä½¿ç”¨ç¨³å®šå¤‡ç”¨å›¾ç‰‡ï¿½?)
  } catch (fallbackError) {
    console.error('å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥:', fallbackError)
    await useFinalFallbackImage()
  }
}

// æœ€ç»ˆå¤‡ç”¨å›¾ç‰‡æ–¹ï¿½?const useFinalFallbackImage = async () => {
  try {
    // æœ€ç»ˆé™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ¨±é“API
    const finalFallbacks = [
      'https://api.r10086.com/img-api.php?type=åŠ¨æ¼«ç»¼åˆ1',
      'https://api.r10086.com/img-api.php?type=åŸç¥æ¨ªå±ç³»åˆ—1',
      'https://api.r10086.com/img-api.php?type=é¬¼ç­ä¹‹åˆƒæ¨ªå±ç³»åˆ—1',
      'https://api.r10086.com/img-api.php?type=ç«å½±å¿è€…æ¨ªå±ç³»ï¿½?',
      'https://api.r10086.com/img-api.php?type=æµ·è´¼ç‹æ¨ªå±ç³»ï¿½?',
      'https://api.r10086.com/img-api.php?type=è¿›å‡»çš„å·¨äººæ¨ªå±ç³»ï¿½?',
      'https://api.r10086.com/img-api.php?type=åˆ€å‰‘ç¥åŸŸæ¨ªå±ç³»ï¿½?',
      'https://api.r10086.com/img-api.php?type=Fateæ¨ªå±ç³»åˆ—1',
      'https://api.r10086.com/img-api.php?type=æ˜æ—¥æ–¹èˆŸ1',
      'https://api.r10086.com/img-api.php?type=å°‘å¥³å‰çº¿1',
      'https://api.r10086.com/img-api.php?type=ä¸œæ–¹project1',
      'https://api.r10086.com/img-api.php?type=Pç«™ç³»ï¿½?',
      'https://api.r10086.com/img-api.php?type=CGç³»åˆ—1',
      'https://api.r10086.com/img-api.php?type=çŒ«å¨˜1'
    ]

    const token = getJWT()
    if (!token) {
      showErrorMessage('è¯·å…ˆç™»å½•åå†è·å–éšæœºå›¾ç‰‡')
      return
    }

    // å°è¯•æ¯ä¸ªæœ€ç»ˆå¤‡ç”¨æº
    for (const finalUrl of finalFallbacks) {
      console.log('å°è¯•æœ€ç»ˆå¤‡ç”¨å›¾ç‰‡æº:', finalUrl)

      try {
        const response = await requestFunc('/random-image', {
          method: 'POST',
          data: {
            apiUrl: finalUrl,
            apiName: 'æœ€ç»ˆå¤‡ï¿½?
          }
        }, true)

        if (response && response.data.success && response.data.imageUrl) {
        if (contentType.value === 'article') {
            articleData.value.image = response.data.imageUrl
        } else {
            mediaData.value.image = response.data.imageUrl
        }
          showErrorMessage('ä½¿ç”¨æœ€ç»ˆå¤‡ç”¨å›¾ç‰‡æº')
        return
        }
      } catch (error) {
        console.warn('å¤‡ç”¨æºå¤±ï¿½?', finalUrl, error)
        continue
      }
    }

    // å¦‚æœæ‰€æœ‰å›¾ç‰‡æºéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showErrorMessage('æ‰€æœ‰å›¾ç‰‡æºéƒ½æ— æ³•è®¿é—®ï¼Œè¯·ç¨åé‡ï¿½?)
  } catch (error) {
    console.error('æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆå¤±ï¿½?', error)
    showErrorMessage('å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å›¾ç‰‡é“¾æ¥')
  }
}

// å›¾ç‰‡é¢„åŠ è½½å‡½ï¿½?const preloadImage = (url) => {
  return new Promise((resolve, reject) => {
    // æ£€æŸ¥ç¼“ï¿½?    if (imageCache.has(url)) {
      resolve(url)
      return
    }

    const img = new Image()
    img.onload = () => {
      imageCache.set(url, true)
      resolve(url)
    }
    img.onerror = () => {
      reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + url))
    }
    img.src = url
  })
}

// å›¾ç‰‡é”™è¯¯å¤„ç†
const handleImageError = (event) => {
  if (!event.target) return
  
  const img = event.target
  const imageUrl = img.src
  
  console.log('å›¾ç‰‡åŠ è½½å¤±è´¥:', imageUrl)
  
  // è·å–å½“å‰é‡è¯•æ¬¡æ•°
  const currentRetryCount = imageRetryCount.value.get(imageUrl) || 0
  
  if (currentRetryCount < 2) { // å‡å°‘é‡è¯•æ¬¡æ•°
    // å¢åŠ é‡è¯•æ¬¡æ•°
    imageRetryCount.value.set(imageUrl, currentRetryCount + 1)
    
    // è®¾ç½®åŠ è½½çŠ¶ï¿½?    imageLoadingStates.value.set(imageUrl, true)
    
    console.log('å°è¯•é‡æ–°åŠ è½½å›¾ç‰‡:', imageUrl)
    
    // ä½¿ç”¨æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°å›¾ï¿½?    const separator = imageUrl.includes('?') ? '&' : '?'
    const newUrl = `${imageUrl}${separator}t=${Date.now()}`
    
    // æ›´æ–°å›¾ç‰‡ï¿½?    if (event.target) {
      event.target.src = newUrl
    }
  } else {
    console.log('å›¾ç‰‡é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™:', imageUrl)
    imageLoadingStates.value.set(imageUrl, false)
  }
}

// å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
const handleImageLoad = (event) => {
  if (!event.target) return
  
  const img = event.target
  const imageUrl = img.src
  
  console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', imageUrl)
  
  // æ¸…é™¤åŠ è½½çŠ¶æ€å’Œé‡è¯•è®¡æ•°
  imageLoadingStates.value.set(imageUrl, false)
  imageRetryCount.value.set(imageUrl, 0)
}

// å½“å‰å›¾ç‰‡çš„åŠ è½½çŠ¶ï¿½?const currentImageLoading = computed(() => {
  const currentImage = contentType.value === 'article' ? articleData.value.image : mediaData.value.image
  if (!currentImage) return false
  
  const loading = imageLoadingStates.value.get(currentImage) || false
  console.log('å½“å‰å›¾ç‰‡åŠ è½½çŠ¶ï¿½?', { currentImage, loading })
  return loading
})

// å½“å‰å›¾ç‰‡çš„é”™è¯¯çŠ¶ï¿½?const currentImageError = computed(() => {
  const currentImage = contentType.value === 'article' ? articleData.value.image : mediaData.value.image
  if (!currentImage) return false
  
  const retryCount = imageRetryCount.value.get(currentImage) || 0
  const isLoading = imageLoadingStates.value.get(currentImage) || false
  const hasError = retryCount > 3 && !isLoading
  console.log('å½“å‰å›¾ç‰‡é”™è¯¯çŠ¶ï¿½?', { currentImage, retryCount, isLoading, hasError })
  return hasError
})

// å›¾ç‰‡ç¼“å­˜å’ŒçŠ¶æ€ç®¡ï¿½?const imageCache = ref(new Map())
const imageLoadingStates = ref(new Map())
const imageRetryCount = ref(new Map())

// æ¸…ç†å‡½æ•°
const cleanup = () => {
  imageCache.value.clear()
  imageLoadingStates.value.clear()
  imageRetryCount.value.clear()
}

// ç»„ä»¶å¸è½½æ—¶æ¸…ï¿½?onBeforeUnmount(() => {
  cleanup()
})

// å¯¼å‡ºå‡½æ•°
defineExpose({
  getRandomImage,
  useFallbackImage,
  useFinalFallbackImage
})
        },
        {
          name: 'æ¨±é“è¿›å‡»çš„å·¨ï¿½?,
          url: 'https://api.r10086.com/img-api.php?type=è¿›å‡»çš„å·¨äººæ¨ªå±ç³»ï¿½?',
          type: 'backend'
        },
        {
          name: 'æ¨±é“åˆ€å‰‘ç¥ï¿½?,
          url: 'https://api.r10086.com/img-api.php?type=åˆ€å‰‘ç¥åŸŸæ¨ªå±ç³»ï¿½?',
          type: 'backend'
        },
        {
          name: 'æ¨±é“Fate',
          url: 'https://api.r10086.com/img-api.php?type=Fateæ¨ªå±ç³»åˆ—1',
          type: 'backend'
        },
        {
          name: 'æ¨±é“è¶…ç”µç£ç‚®',
          url: 'https://api.r10086.com/img-api.php?type=æŸç§‘å­¦çš„è¶…ç”µç£ç‚®æ¨ªå±ç³»åˆ—1',
          type: 'backend'
        },
        {
          name: 'æ¨±é“åŸç¥',
          url: 'https://api.r10086.com/img-api.php?type=åŸç¥æ¨ªå±ç³»åˆ—1',
          type: 'backend'
        },
        {
          name: 'æ¨±é“ä¸œäº¬é£Ÿå°¸ï¿½?,
          url: 'https://api.r10086.com/img-api.php?type=ä¸œäº¬é£Ÿå°¸é¬¼æ¨ªå±ç³»ï¿½?',
          type: 'backend'
        },
        {
          name: 'æ¨±é“ä¸ºç¾å¥½ä¸–ç•ŒçŒ®ä¸Šç¥ï¿½?,
          url: 'https://api.r10086.com/img-api.php?type=ä¸ºç¾å¥½ä¸–ç•ŒçŒ®ä¸Šç¥ç¦æ¨ªå±ç³»ï¿½?',
          type: 'backend'
        },
        {
          name: 'æ¨±é“æˆ‘çš„ä¸–ç•Œ',
          url: 'https://api.r10086.com/img-api.php?type=æˆ‘çš„ä¸–ç•Œç³»åˆ—1',
          type: 'backend'
        },
