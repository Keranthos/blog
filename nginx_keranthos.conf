server {
    server_name keranthos.me www.keranthos.me;

    # 前端静态资源
    root /var/www/blog;
    index index.html;

    # HTML 文件不缓存（确保更新及时）- 必须在 location / 之前，优先级更高
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        try_files $uri $uri/ /index.html;
    }

    # 前端路由历史模式支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_set_header Host $host;
        
        # 使用 Cloudflare 真实 IP
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cloudflare 相关头部
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-Visitor $http_cf_visitor;
        
        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 后端静态上传文件（使用 ^~ 确保优先级高于正则 location）
    location ^~ /uploads/ {
        alias /opt/blog/backend/uploads/;
        
        # 缓存设置
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # 静态资源缓存（CSS、JS、字体）- /uploads/ 已用 ^~ 排除，不会被此规则匹配
    location ~* \.(js|css|woff|woff2|ttf|eot)$ {
        expires 365d;  # 长期缓存，通过文件名哈希实现版本控制
        add_header Cache-Control "public, immutable";
        access_log off;  # 不记录静态资源访问日志，减少 I/O
    }

    # 图片资源缓存（WebP 优先）
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
        expires 90d;
        add_header Cache-Control "public";
        access_log off;
        # 如果浏览器支持 WebP，可以通过 Cloudflare 自动转换（CF 设置中启用）
    }

    # Gzip 压缩（文本资源）
    gzip on;
    gzip_vary on;
    gzip_min_length 256;  # 降低阈值，压缩更多小文件
    gzip_comp_level 6;    # 压缩级别（1-9，6 是性能和压缩率的平衡）
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/x-javascript application/json application/xml+rss application/xml;
    # 注意：text/html 已由 Nginx 默认包含，无需重复指定
    gzip_disable "msie6";  # 禁用 IE6 gzip（IE6 不支持）
    gzip_proxied any;     # 对所有代理请求启用 gzip

    # Brotli 压缩（需要安装 nginx-module-brotli，比 gzip 压缩率高 15-20%）
    # 注意：如果服务器未安装 brotli 模块，以下配置会被忽略
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss application/xml text/html;
    # brotli_min_length 256;

    # HTTP/2 Server Push（预加载关键资源）
    # 注意：http2_push_preload 需要 Nginx 1.13.9+ 且需要手动编译支持
    # http2_push_preload on;  # 当前版本可能不支持，已注释

    # 优化连接
    keepalive_timeout 65;
    keepalive_requests 100;
    tcp_nodelay on;
    tcp_nopush on;

    listen 443 ssl http2;  # 启用 HTTP/2
    ssl_certificate /etc/letsencrypt/live/keranthos.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/keranthos.me/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = www.keranthos.me) {
        return 301 https://$host$request_uri;
    }

    if ($host = keranthos.me) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name keranthos.me www.keranthos.me;
    return 404;
}

