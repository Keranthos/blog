项目部署指引（生产环境）

一、总体建议
1) 同源部署（推荐）：
   - 前端静态资源与后端 API 使用同一域名。
   - 反向代理规则：
     - /           → 前端构建后的静态目录
     - /api        → 后端进程（默认 http://127.0.0.1:3000）
     - /uploads    → 后端进程（由后端提供静态文件 r.Static("/uploads", "./uploads")）
   - 前端代码无需改动，保持使用相对路径 /api、/uploads。

2) 异源部署（前后端不同域名/端口）：
   - 确保后端 CORS 白名单包含前端域名（routes.go 已启用 CORS，可调整 AllowOrigins）。
   - 前端可通过 Nginx 把 /api、/uploads 反代到后端域名，或在构建前注入环境变量指定后端基地址（如 VUE_APP_API_BASE）。

二、后端服务（Go + Gin）
1) 启动参数
   - 使用配置文件 backend/config/config.yml（数据库、JWT 等）。
   - 启动命令（示例）：
     - Windows: backend/run.bat 或 backend/start-server.bat
     - Linux:   可直接 go build && ./main 或使用 systemd（见下）。

2) systemd（Linux）示例
[Unit]
Description=Blog Backend
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/blog/backend
ExecStart=/opt/blog/backend/main
Restart=always
Environment=GIN_MODE=release

[Install]
WantedBy=multi-user.target

   - 确保 /opt/blog/backend/uploads 具有可写权限，建议挂载为独立磁盘或 Docker 卷。

3) 静态上传目录
   - 后端已暴露 /uploads → ./uploads。
   - 生产环境务必持久化该目录，避免升级/重启导致文件丢失。
   - 可在 Nginx 上对 /uploads 增加缓存头、限流、防盗链（可选）。

4) 封面本地化机制（已实现）
   - 创建/更新 博客/项目/科研/随笔 时，如 image 为外链，会下载至 ./uploads/images/ 并替换为站内 URL。
   - 安全策略：MIME 白名单、5MB 上限、最多 3 次跳转、SSRF 基础防护、内容哈希命名与去重、超时控制。
   - 历史数据批处理：
     - 管理员端点 POST /api/articles/migrate-images（一次性本地化历史外链封面，并把“建立一个项目2_GORM入门”的封面替换为前端博客顶部图）。
     - 或在服务器上运行批处理：go run ./cmd/migrate-images（需要在 backend 目录执行且配置可用）。

三、前端（Vue）
1) 开发环境（本地）
   - devServer 代理已指向 http://localhost:3000 的 /api 与 /uploads。
   - 生产环境不会读取 devServer 配置。

2) 构建与部署
   - 进入 frontend 目录：
     npm ci
     npm run build
   - 将 frontend/dist 发布到 Nginx 静态目录（见四）。

四、Nginx（同源部署示例）
server {
    listen 80;
    server_name your.domain.com;

    # 前端静态资源
    root /opt/blog/frontend/dist;
    index index.html;

    # 前端路由历史模式（如使用）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端静态上传
    location /uploads/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_set_header Host $host;
        expires 7d; # 可选缓存
    }

    # HTTPS 建议使用 certbot/ACME 配置
}

五、环境变量/配置建议
- GIN_MODE=release（生产）
- 数据库连接超时、连接池参数在 config.InitDB 中已设较稳健，可按需调整。
- 如接入 CDN：将 /uploads 走 CDN 回源后端；前端可保持 /uploads，不必改代码。

六、备份/监控
- 定期备份数据库与 uploads 目录。
- Nginx 与后端日志统一到 journald 或文件；可考虑接入 Prometheus/Alertmanager（可选）。

七、常见问题
1) 开发模式图片 404：需确保前端代理了 /uploads（已配置）。
2) 生产图片 404：检查 Nginx 是否将 /uploads 反代到后端；确认后端进程可写 ./uploads 并有文件。
3) 外链下载失败：查看后端日志，可能是超时、MIME 不在白名单、文件过大或被 SSRF 防护拦截。

— 完 —
